<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Simulador de Geladeira</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="inputs.css">
    <link rel="stylesheet" href="switch.css">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

</head>

<body>
    <div class="painel">
        <div id="statusComponentesSistema">
            <h4>Componentes do Sistema</h4>
            <span>Compressor
                <label class="switch">
                    <input type="checkbox" id="toggleCompressor">
                    <div class="slider round">
                        <span class="on">ON</span>
                        <span class="off">OFF</span>
                    </div>
                </label>
            </span>
            <span for="togglePortaFreezer">Porta Freezer
                <label class="switch">
                    <input type="checkbox" id="togglePortaFreezer">
                    <div class="slider round">
                        <span class="on">ON</span>
                        <span class="off">OFF</span>
                    </div>
                </label>
            </span>
            <span for="togglePortaGeladeira">Porta Geladeira
                <label class="switch">
                    <input type="checkbox" id="togglePortaGeladeira">
                    <div class="slider round">
                        <span class="on">ON</span>
                        <span class="off">OFF</span>
                    </div>
                </label>
            </span>
            <span for="toggleResistencia">Resistência
                <label class="switch">
                    <input type="checkbox" id="toggleResistencia">
                    <div class="slider round">
                        <span class="on">ON</span>
                        <span class="off">OFF</span>
                    </div>
                </label>
            </span>
            <span for="toggleVentoinhaCompressor">Ventoinha Compressor
                <label class="switch">
                    <input type="checkbox" id="toggleVentoinhaCompressor">
                    <div class="slider round">
                        <span class="on">ON</span>
                        <span class="off">OFF</span>
                    </div>
                </label>
            </span>
            <span for="toggleVentoinhaFreezer">Ventoinha Freezer
                <label class="switch">
                    <input type="checkbox" id="toggleVentoinhaFreezer">
                    <div class="slider round">
                        <span class="on">ON</span>
                        <span class="off">OFF</span>
                    </div>
                </label>
            </span>
            <span for="pauseButton">Pausar
                <label class="switch">
                    <input type="checkbox" id="pauseButton">
                    <div class="slider round">
                        <span class="on">ON</span>
                        <span class="off">OFF</span>
                    </div>
                </label>
                <br>
                <label for="velocidade">Velocidade
                    <input type="range" id="velocidade" min="1" max="100" step="1" value="1">
                    <span id="velocidadeValor">1x=1s </span>
                </label>
        </div>
        <div id="statusTemperatura">
            <h4>Temperaturas</h4>
            <div>
                <label for="tempAmbiente"> Ambiente ºC</label>
                <input type="text" id="tempAmbiente" value="0" disabled>
            </div>

            <label for="tempFreezer">Freezer ºC</label>
            <input type="text" id="tempFreezer" value="0" disabled>
            <label for="tempEvaporador"> Evaporador ºC</label>
            <input type="text" id="tempEvaporador" value="0" disabled>
            <label for="tempResistencia"> Resistência ºC</label>
            <input type="text" id="tempResistencia" value="0" disabled>
            <label for="tempMotor"> Motor ºC</label>
            <input type="text" id="tempMotor" value="0" disabled>
            <label for="statusSistema">Status do Sistema</label>
            <input type="text" id="statusSistema" value="Desligado" disabled>
            <label for="statusSistema">Tempo Simulação</label>
            <input type="text" id="tempoSimulacao" value="0" disabled>

            <label for="statusSistema">Rele Térmico</label>
            <input type="text" id="statusSistema" value="Desligado" disabled>
            <label for="statusSistema"> Rele Térmico ºC</label>
            <input type="text" id="statusSistema" value="0" disabled>


        </div>

        <div id="graficoTemperaturas"></div>


    </div>

    <script src="SimuladorGeladeira.js"></script>
    <script>

        document.addEventListener("DOMContentLoaded", function () {

            const geladeira = new SimuladorGeladeira();
            let pausado = true;

            function togglePause() {
                pausado = !pausado;
                document.getElementById("pauseButton").innerText = pausado ? "Retomar" : "Pausar";
            }

            //define os eventos dos botões  e eventos 
            document.getElementById("toggleCompressor").addEventListener("click", toggleCompressor);
            document.getElementById("togglePortaFreezer").addEventListener("click", togglePortaFreezer);
            document.getElementById("togglePortaGeladeira").addEventListener("click", togglePortaGeladeira);
            document.getElementById("toggleResistencia").addEventListener("click", toggleResistencia);
            document.getElementById("toggleVentoinhaCompressor").addEventListener("click", toggleVentoinhaCompressor);
            document.getElementById("toggleVentoinhaFreezer").addEventListener("click", toggleVentoinhaFreezer);
            document.getElementById("velocidade").addEventListener("input", (e) => atualizarVelocidadeSimulacao(e.target.value));
            document.getElementById("pauseButton").addEventListener("click", togglePause)
            document.getElementById("pauseButton").click();


            // Atualiza o status atuadores sistema frigorífico
            function toggleCompressor() { geladeira.compressorLigado = !geladeira.compressorLigado; }
            function togglePortaFreezer() { geladeira.portaFreezerAberta = !geladeira.portaFreezerAberta; }
            function togglePortaGeladeira() { geladeira.portaGeladeiraAberta = !geladeira.portaGeladeiraAberta; }
            function toggleResistencia() { geladeira.resistenciaLigada = !geladeira.resistenciaLigada; }
            function toggleVentoinhaCompressor() { geladeira.ventoinhaCompressor = !geladeira.ventoinhaCompressor; }
            function toggleVentoinhaFreezer() { geladeira.ventoinhaFreezer = !geladeira.ventoinhaFreezer; }

            // Atualiza o status do sistema frigorífico
            function atualizarStatus() {
                //Recupera componentes do sistema no dom e associa a variável 
                const statusMotorCompressor = document.getElementById("toggleCompressor");
                const statusPortaFreezer = document.getElementById("togglePortaFreezer");
                const statusPortaGeladeira = document.getElementById("togglePortaGeladeira");
                const statusResistencia = document.getElementById("toggleResistencia");
                const statusVentoinhaCompressor = document.getElementById("toggleVentoinhaCompressor");
                const statusVentoinhaFreezer = document.getElementById("toggleVentoinhaFreezer");
                const statusTemperatura = document.getElementById("statusTemperatura");

                // Atualiza o status dos componentes do sistema
                statusMotorCompressor.checked = geladeira.compressorLigado;
                statusPortaFreezer.checked = geladeira.portaFreezerAberta;
                statusPortaGeladeira.checked = geladeira.portaGeladeiraAberta;
                statusResistencia.checked = geladeira.resistenciaLigada;
                statusVentoinhaCompressor.checked = geladeira.ventoinhaCompressor;
                statusVentoinhaFreezer.checked = geladeira.ventoinhaFreezer;
                //Recuppera os elementos do DOM e atualiza os valores de temperatura e associa a variável locais
                const tempAmbiente = document.getElementById("tempAmbiente");
                const tempFreezer = document.getElementById("tempFreezer");
                const tempEvaporador = document.getElementById("tempEvaporador");
                const tempResistencia = document.getElementById("tempResistencia");
                const tempMotor = document.getElementById("tempMotor");

                // Atualiza os valores de temperatura
                tempAmbiente.value = `${geladeira.temperaturaAmbiente.toFixed(4)}`;
                tempFreezer.value = `${geladeira.temperaturaFreezer.toFixed(4)}`;
                tempEvaporador.value = `${geladeira.temperaturaEvaporador.toFixed(4)}`;
                tempResistencia.value = `${geladeira.temperaturaResistencia.toFixed(4)}`;
                tempMotor.value = `${geladeira.temperaturaCompressor.toFixed(4)}`;
                // Atualiza o status do sistema
                const statusSistema = document.getElementById("statusSistema");
                const statusReleTermico = document.getElementById("statusReleTermico");
                const statusTemperaturaReleTermico = document.getElementById("statusTemperaturaReleTermico");
                statusSistema.value = geladeira.statusSistema;
                //statusReleTermico.value = geladeira.statusReleTermico;
                //  statusTemperaturaReleTermico.value = geladeira.temperaturaReleTermico.toFixed(2);
                // Atualiza o tempo de simulação
                const tempoSimulacao = document.getElementById("tempoSimulacao");
                tempoSimulacao.value = formatarTempo(geladeira.getTempoSimulacao());


            }
            // Atualiza o status a cada segundo
            let fatorVelocidade = 1; // cada unidade simulada = 1 segundo real
            let intervaloAtualizacao = 1000; // Atualiza a cada 50ms (20 vezes por segundo)

            function atualizarVelocidadeSimulacao(valor) {
                fatorVelocidade = parseInt(valor);
                document.getElementById('velocidadeValor').innerText =
                    `1s real = ${fatorVelocidade} segundos simulados`;
            }


            // Chamadas regulares (sem precisar alterar o intervalo)
            // Atualiza o sistema frigorífico a cada 1000ms
            setInterval(() => {
                if (!pausado) {
                    for (let i = 0; i < fatorVelocidade; i++) {
                        geladeira.atualizar(1); // Avança 1 segundo
                        // Atualiza status dos controles
                    }
                }
                atualizarStatus();
            }, 1000); // Sistema: 1 segundo real

            // Atualiza o gráfico 10 vezes por segundo (a cada 100ms)
            setInterval(() => {
                if (!pausado) {
                    atualizarGrafico(
                        geladeira.getTempoSimulacao(),
                        geladeira.temperaturaAmbiente,
                        geladeira.temperaturaFreezer,
                        geladeira.temperaturaEvaporador,
                        geladeira.temperaturaResistencia,
                        geladeira.temperaturaCompressor
                    );
                }
            }, 1000); // Gráfico: 100ms = 10x por segundo

            // Atualiza o gráfico com os dados mais recentes
            function proximoEstadoSimulacao() {
                geladeira.atualizar(1);
                atualizarStatus();
                console.log(`Tempo: ${geladeira.getTempoSimulacao()}, Ambiente: ${geladeira.temperaturaAmbiente}, Freezer: ${geladeira.temperaturaFreezer}, Evaporador: ${geladeira.temperaturaEvaporador}, Resistência: ${geladeira.temperaturaResistencia}, Motor: ${geladeira.temperaturaCompressor}`);

            }



            let apexChart; // Variável global para guardar o gráfico




            const LIMITE_PONTOS = 36000; // Máximo de 3000 pontos por série

            function atualizarGrafico(tempoSimulacao, amb, freezer, evap, res, motor) {
                const container = document.getElementById('graficoTemperaturas');

                if (!apexChart) {
                    const options = {
                        chart: {
                            type: 'line',
                            height: 400,
                            animations: {
                                enabled: true,
                                easing: 'linear',
                                dynamicAnimation: { speed: 1000 }
                            },
                            toolbar: {
                                show: true,
                                tools: {
                                    zoom: true,
                                    pan: true,
                                    reset: true
                                }
                            },
                            zoom: {
                                enabled: true,
                                type: 'x',
                                autoScaleYaxis: true
                            }
                        },
                        series: [
                            { name: 'Ambiente', data: [] },
                            { name: 'Freezer', data: [] },
                            { name: 'Evaporador', data: [] },
                            { name: 'Resistência', data: [] },
                            { name: 'Motor Compressor', data: [] }
                        ],
                        xaxis: {
                            type: 'numeric',
                            range: 100,
                            title: { text: 'Tempo (s)' }
                        },
                        yaxis: {
                            min: -35,
                            max: 130,
                            title: { text: 'Temperatura (°C)' }
                        },
                        legend: { position: 'top' }
                    };

                    apexChart = new ApexCharts(container, options);
                    apexChart.render();
                }

                const seriesAtual = apexChart.w.config.series;
                const tempoAtual = tempoSimulacao;

                // Adiciona novos dados
                seriesAtual[0].data.push({ x: tempoAtual, y: amb });
                seriesAtual[1].data.push({ x: tempoAtual, y: freezer });
                seriesAtual[2].data.push({ x: tempoAtual, y: evap });
                seriesAtual[3].data.push({ x: tempoAtual, y: res });
                seriesAtual[4].data.push({ x: tempoAtual, y: motor });

                // Limita o número de pontos para não travar
                seriesAtual.forEach(serie => {
                    if (serie.data.length > LIMITE_PONTOS) {
                        serie.data.shift(); // remove o ponto mais antigo
                    }
                });

                apexChart.updateSeries(seriesAtual);
            }




        });

        //função que recebe um valor em segundos e retorna o tempo hh:mm:ss abrevidando da menor forma possível somente ss ou mm:ss ou hh:mm:ss
        function formatarTempo(tempo) {
            const horas = Math.floor(tempo / 3600);
            const minutos = Math.floor((tempo % 3600) / 60);
            const segundos = Math.floor(tempo % 60);

            if (horas > 0) {
                return `${horas}:${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
            } else if (minutos > 0) {
                return `${minutos}:${segundos.toString().padStart(2, '0')}`;
            } else {
                return `00:${segundos.toString().padStart(2, '0')}`;
            }
        }


    </script>
</body>

</html>